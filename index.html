<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laporan 5R/5S - Before & After</title>

<style>
:root{
  --primary:#1976d2;
  --bg:#f2f4f7;
  --card:#ffffff;
  --border:#e0e0e0;
}
body{
  font-family:Segoe UI,Arial,sans-serif;
  background:var(--bg);
  padding:20px;
}
.container{
  max-width:1000px;
  margin:auto;
  background:var(--card);
  padding:24px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}
h1{text-align:center;color:var(--primary)}
.form-group{margin-bottom:14px}
label{font-weight:600;display:block;margin-bottom:6px}
input,select,button,textarea{
  width:100%;
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
}
.card{
  margin-top:20px;
  padding:16px;
  background:#fafafa;
  border-left:5px solid var(--primary);
  border-radius:10px;
}
.photo-preview{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid var(--border);
  margin-top:8px;
}
.actions{display:flex;gap:12px;margin-top:20px}
button{
  background:var(--primary);
  color:#fff;
  border:none;
  cursor:pointer;
  padding:12px;
}
button.secondary{
  background:#e0e0e0;
  color:#333;
}
#loading{text-align:center;margin-top:20px;font-weight:bold;display:none}
.tabs{
  display:flex;
  gap:12px;
  justify-content:center;
  margin-bottom:24px;
}
.tab-btn{
  padding:10px 20px;
  background:#eee;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.tab-btn.active{
  background:var(--primary);
  color:white;
}
.hidden{display:none;}
</style>
</head>

<body>

<div class="tabs">
  <button type="button" class="tab-btn active" onclick="showTab('before')">üì∏ Temuan (Before)</button>
  <button type="button" class="tab-btn" onclick="showTab('after')">‚úÖ Perbaikan (After)</button>
</div>

<!-- TAB BEFORE -->
<div id="beforeTab" class="container">
  <h1>üìã Laporan Temuan (Before)</h1>

  <div class="form-group">
    <label>Nama Penginput</label>
    <input type="text" id="nama" required>
  </div>

  <div class="form-group">
    <label>Tanggal</label>
    <input type="date" id="tanggal" required>
  </div>

  <div id="temuanList"></div>

  <div class="actions">
    <button type="button" onclick="addTemuan()" class="secondary">‚ûï Tambah Temuan</button>
    <button type="button" onclick="submitBefore()">üì§ Kirim Temuan</button>
  </div>

  <div id="kodeResult" style="margin-top:20px; padding:12px; background:#e8f5e9; border-radius:8px; display:none;"></div>
  <div id="loadingBefore" style="display:none;">‚è≥ Mengirim...</div>
</div>

<!-- TAB AFTER -->
<div id="afterTab" class="container hidden">
  <h1>‚úÖ Input Foto Perbaikan (After)</h1>

  <div class="form-group">
    <label>Kode Unik Temuan</label>
    <input type="text" id="kodeUnik" placeholder="Masukkan kode unik dari temuan sebelumnya" required>
  </div>

  <button type="button" onclick="openAfterCamera()">üì∏ Ambil Foto Perbaikan</button>
  <img id="fotoAfterPreview" class="photo-preview" style="display:none;">

  <div class="actions">
    <button type="button" onclick="submitAfter()">üì§ Kirim Foto After</button>
  </div>

  <div id="loadingAfter" style="display:none;">‚è≥ Mengirim...</div>
</div>

<!-- CAMERA MODAL -->
<div id="cameraModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:999;align-items:center;justify-content:center">
  <div style="background:#fff;padding:16px;border-radius:12px;max-width:420px;width:100%">
    <video id="video" autoplay playsinline style="width:100%;border-radius:10px"></video>
    <canvas id="canvas" style="display:none"></canvas>
    <div style="display:flex;gap:10px;margin-top:10px">
      <button type="button" onclick="takePhoto()">üì∏ Ambil Foto</button>
      <button type="button" onclick="closeCamera()" class="secondary">‚ùå Tutup</button>
    </div>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-7TbvIXzMfEQM6lvnRvdm07Bnekj33Tn_4RRHUxe3WWG2_qVIuklckg2DS_nLZ_Km/exec";

let temuanIndex = 0;
let camTarget = null;
let currentStream = null;

/* ================= TAB ================= */
function showTab(tab) {
  document.getElementById('beforeTab').classList.toggle('hidden', tab !== 'before');
  document.getElementById('afterTab').classList.toggle('hidden', tab !== 'after');
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(tab === 'before' ? '.tab-btn:nth-child(1)' : '.tab-btn:nth-child(2)').classList.add('active');
}

/* ================= TEMUAN ================= */
function addTemuan() {
  temuanIndex++;
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    <h3>Temuan #${temuanIndex}</h3>
    <div class="form-group">
      <label>Bagian</label>
      <input type="text" id="bagian_${temuanIndex}" required>
    </div>
    <div class="form-group">
      <label>Lokasi</label>
      <input type="text" id="lokasi_${temuanIndex}" required>
    </div>
    <div class="form-group">
      <label>Deskripsi</label>
      <textarea id="deskripsi_${temuanIndex}" rows="3" required></textarea>
    </div>
    <button type="button" onclick="openBeforeCamera(${temuanIndex})">üì∏ Ambil Foto Before</button>
    <img id="fotoBefore_${temuanIndex}" class="photo-preview" style="display:none;">
  `;
  document.getElementById('temuanList').appendChild(div);
}

/* ================= KAMERA ================= */
async function openCamera(target) {
  camTarget = target;
  document.getElementById('cameraModal').style.display = "flex";
  currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
  document.getElementById('video').srcObject = currentStream;
}

function openBeforeCamera(i) { openCamera(`before_${i}`); }
function openAfterCamera() { openCamera('after'); }

function takePhoto() {
  const v = document.getElementById('video');
  const c = document.getElementById('canvas');
  c.width = v.videoWidth || 320;
  c.height = v.videoHeight || 240;
  c.getContext('2d').drawImage(v, 0, 0, c.width, c.height);
  const img = c.toDataURL("image/jpeg", 0.85);

  if (camTarget === 'after') {
    const el = document.getElementById('fotoAfterPreview');
    el.src = img; el.style.display = "block";
  } else {
    const i = camTarget.split('_')[1];
    const el = document.getElementById(`fotoBefore_${i}`);
    el.src = img; el.style.display = "block";
  }
  closeCamera();
}

function closeCamera() {
  document.getElementById('cameraModal').style.display = "none";
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
}

/* ================= SUBMIT BEFORE ================= */
async function submitBefore() {
  const nama = document.getElementById("nama").value.trim();
  const tanggal = document.getElementById("tanggal").value;
  if (!nama || !tanggal || temuanIndex === 0) return alert("Lengkapi data!");

  const temuan = [];
  const kodeList = [];

  for (let i = 1; i <= temuanIndex; i++) {
    const foto = document.getElementById(`fotoBefore_${i}`).src;
    if (!foto.startsWith("data:image")) return alert(`Foto before #${i} belum ada`);

    const kode = "TS" + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2,4).toUpperCase();
    kodeList.push(kode);

    temuan.push({
      kode_unik: kode,
      bagian: document.getElementById(`bagian_${i}`).value.trim(),
      lokasi: document.getElementById(`lokasi_${i}`).value.trim(),
      deskripsi: document.getElementById(`deskripsi_${i}`).value.trim(),
      foto_before: foto
    });
  }

  document.getElementById('loadingBefore').style.display = "block";

  await fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "submit_before", nama, tanggal, temuan })
  });

  document.getElementById('loadingBefore').style.display = "none";
  document.getElementById('kodeResult').innerHTML =
    "<b>Berhasil!</b><br><ul>" + kodeList.map(k => `<li><code>${k}</code></li>`).join("") + "</ul>";
  document.getElementById('kodeResult').style.display = "block";

  if (kodeList.length === 1) document.getElementById('kodeUnik').value = kodeList[0];
  showTab('after');
}

/* ================= SUBMIT AFTER ================= */
async function submitAfter() {
  const kode = document.getElementById("kodeUnik").value.trim();
  const foto = document.getElementById("fotoAfterPreview").src;
  if (!kode || !foto.startsWith("data:image")) return alert("Data belum lengkap");

  document.getElementById('loadingAfter').style.display = "block";

  await fetch(WEB_APP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action: "submit_after", kode_unik: kode, foto_after: foto })
  });

  document.getElementById('loadingAfter').style.display = "none";
  alert("‚úÖ Foto after terkirim");
}

/* ================= INIT ================= */
addTemuan();
</script>

</body>

</html>



